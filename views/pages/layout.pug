extends ../base/layout
include mixins.pug

block title
    title TaD | #{page.name}

block append styles
    - icons = ['delete','edit','add_circle','file_upload', 'check', 'add', 'cancel'].sort()
    link(
        href=`https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,100,1,200&icon_names=${icons.join(',')}&display=swap` 
        rel="stylesheet")
    style.
        .material-icon-button {
        display: inline-flex; /* Align icon and text if present */
        align-items: center;
        justify-content: center;
        background-color: #f0f0f0; /* Example background color */
        color: #333; /* Example icon color */
        border: none;
        border-radius: 50%; /* For a circular button */
        width: 48px; /* Example size */
        height: 48px; /* Example size */
        cursor: pointer;
        outline: none;
        transition: background-color 0.3s ease; /* Smooth hover effect */
        }

        .material-icon-button:hover {
        background-color: #e0e0e0; /* Hover background color */
        }

        .material-icon-button:active {
        background-color: #d0d0d0; /* Active background color */
        }

        .material-icon-button .material-icons {
        font-size: 24px; /* Icon size */
        }

        ul .item {
            list-style-type: none;
        }

block append scripts
    //- script(src="/js/tadDocs.js" defer)
    link(href="/css/lib/jshighlight-atom-one-dark-min.css" type="text/css" rel="stylesheet")
    script(src="/js/highlight.min.js")
    if admin
        script(src="https://cdn.jsdelivr.net/gh/WebCoder49/code-input@2.7/code-input.min.js")
        link(rel="stylesheet" href="https://cdn.jsdelivr.net/gh/WebCoder49/code-input@2.7/code-input.min.css")
        script(src="https://cdn.jsdelivr.net/gh/WebCoder49/code-input@2.7/plugins/indent.min.js")
        script.
            codeInput.registerTemplate("syntax-highlighted",
                new codeInput.templates.Hljs(
                    hljs,
                    [
                        // You can add or remove plugins in this list from https://code-input-js.org/plugins.
                        // All plugins used must be imported above.
                        new codeInput.plugins.Indent()
                    ]
                )
            );
            
        

block content
    //- article
    div(class="flex" style="justify-content: space-between; align-items: center;")
        +breadcrumbs(page.slug)
        if admin
            div(role="group" class="flex1" aria-label="Admin Actions")
                i(role="button" hx-get=`/tad/create` hx-target="#dialog-container" hx-swap="innerHTML" class="material-symbols-outlined")="add_circle"
                label.btn(for="fileinput" role="button") Upload JS
                input#fileinput(type="file" role="button" name="file" style="display:none;" class="clickable" accept=".js,.ts")
                form(id="upload" method="POST" action="/tad/upload"  hx-post="/tad/upload" hx-target="#dialog-container" hx-swap="innerHTML" style="display:inline")
                    input(type="hidden" name="parent_id" value=page.id)
                    input(type="hidden" name="filecontent" value="")
    
    if loadTadPage
        div(id="page-details" hx-trigger="load" hx-get=`/tad/` hx-target="#page-details" hx-swap="outerHTML")="Loading page details..."
    else 
        div(id="page-details" hx-trigger="load" hx-get=`/tad/view/${page.id}` hx-target="#page-details" hx-swap="outerHTML")="Loading page details..."

    block typeDetails 
        case page.page_type
            when 'class'
                article(id="type-details" hx-trigger="load" hx-get=`/classes/view/${page.id}` hx-target="#type-details" hx-swap="outerHTML")="Loading module details..."
            when 'property'
                article(id="type-details" hx-trigger="load" hx-get=`/properties/view/${page.id}` hx-target="#type-details" hx-swap="outerHTML")="Loading property details..."
            when 'method'
                article(id="type-details" hx-trigger="load" hx-get=`/methods/view/${page.id}` hx-target="#type-details" hx-swap="outerHTML")="Loading method details..."

    article(id="example-section" hx-trigger="load" hx-get=`/examples/${page.code_example_id}` hx-target="#example-section" hx-swap="outerHTML" hx-swap-oob="true")
        h2 Examples
        p Loading Example...



    div#dialog-container
    if admin
        script.
            let uploadForm = document.querySelector('#fileinput');
            uploadForm.addEventListener('change', (event) => {
            console.log('file selected, submitting form');
            const file = event.target.files[0];
            if(file){
                const reader = new FileReader();
                reader.onload = function(e) {
                const content = e.target.result;
                document.querySelector('input[name="filecontent"]').value = content;
                document.querySelector('#upload').requestSubmit();
                };
            
                reader.readAsText(file);
            }
            });

            function augment_textarea(event) { 
                const target = event.target || event.srcElement;
                const form = target.closest && target.closest('form') || document.querySelector("#notes_form");
                if (event.key === 'Enter' && !event.shiftKey) {
                    console.log("Submitting form via augment_textarea");
                    event.preventDefault();
                    form.requestSubmit();  
                    //we give a touch of time for the form to have pulled data.
                }
            }

            function toggleEditItem(event){
                event.preventDefault();
                const item = event.target.closest('.item')
                item.querySelector('.viewItem').classList.toggle('hidden');
                item.querySelector('.editItem').classList.toggle('hidden');
            }

            function toggleEditPage(event){
                event.preventDefault();
                const item = event.target.closest('#page-details')
                item.querySelector('.viewPage').classList.toggle('hidden');
                item.querySelector('.editPage').classList.toggle('hidden');
            }

            function toggleAddItem(event){
                event.preventDefault();
                const section = event.target.closest('section');
                section.querySelector('.add-item').classList.toggle('hidden');
                section.querySelector('.add-button').classList.toggle('hidden');
            }

            function toggleEditTypeDetails(event){
                event.preventDefault();
                const item = event.target.closest('#type-details')
                item.querySelector('.viewTypeDetails').classList.toggle('hidden');
                item.querySelector('.editTypeDetails').classList.toggle('hidden');
            }

    script.
        document.addEventListener('DOMContentLoaded', (event) => {
            console.log(window.location);
            document.body.addEventListener('htmx:afterSwap', function(event) {
                console.log("htmx afterSwap event:", event);
                if(!window.location.pathname){
                    return;
                }
                let location = window.location.pathname.split('/');
                let slug = location[location.length -1];
                if(slug === 'tad' || slug === ''){
                    slug = 'home';
                }

                slug = slug.charAt(0).toUpperCase() + slug.slice(1);
                let title = "TaD | " + slug;
                document.title = title;
            });
        });

